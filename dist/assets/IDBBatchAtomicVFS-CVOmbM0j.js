import{S as c,a as o,b as $,c as T,d as I,e as N,f as v,g as x,h as R,i as p,j as P,k as O,l as V,m as H,n as K,o as U,p as M,q as B,r as z}from"./SharedSyncImplementation.worker-BMXqdOVv.js";class Q{mxPathName=64;xClose(e){return c}xRead(e,t,r){return c}xWrite(e,t,r){return c}xTruncate(e,t){return c}xSync(e,t){return o}xFileSize(e,t){return c}xLock(e,t){return o}xUnlock(e,t){return o}xCheckReservedLock(e,t){return t.setInt32(0,0,!0),o}xFileControl(e,t,r){return $}xSectorSize(e){return 512}xDeviceCharacteristics(e){return 0}xOpen(e,t,r,s){return T}xDelete(e,t){return c}xAccess(e,t,r){return c}handleAsync(e){return e()}}const W=I|p|x|P|R;class X{get state(){return this.#e}#e=I;timeoutMillis=0;#r=new Map;#t=Promise.resolve(0);async lock(e){return this.#s(this.#i,e)}async unlock(e){return this.#s(this.#a,e)}async isSomewhereReserved(){throw new Error("unimplemented")}async#s(e,t){const r=t&W;try{const s=()=>e.call(this,r);return await(this.#t=this.#t.then(s,s)),this.#e=r,o}catch(s){return s.name==="AbortError"?N:(console.error(s),v)}}async#i(e){if(e===this.#e)return o;switch(this.#e){case I:switch(e){case p:return this._NONEtoSHARED();default:throw new Error(`unexpected transition ${this.#e} -> ${e}`)}case p:switch(e){case x:return this._SHAREDtoRESERVED();case R:return this._SHAREDtoEXCLUSIVE();default:throw new Error(`unexpected transition ${this.#e} -> ${e}`)}case x:switch(e){case R:return this._RESERVEDtoEXCLUSIVE();default:throw new Error(`unexpected transition ${this.#e} -> ${e}`)}default:throw new Error(`unexpected transition ${this.#e} -> ${e}`)}}async#a(e){if(e===this.#e)return o;switch(this.#e){case R:switch(e){case p:return this._EXCLUSIVEtoSHARED();case I:return this._EXCLUSIVEtoNONE();default:throw new Error(`unexpected transition ${this.#e} -> ${e}`)}case x:switch(e){case p:return this._RESERVEDtoSHARED();case I:return this._RESERVEDtoNONE();default:throw new Error(`unexpected transition ${this.#e} -> ${e}`)}case p:switch(e){case I:return this._SHAREDtoNONE();default:throw new Error(`unexpected transition ${this.#e} -> ${e}`)}default:throw new Error(`unexpected transition ${this.#e} -> ${e}`)}}async _NONEtoSHARED(){}async _SHAREDtoEXCLUSIVE(){await this._SHAREDtoRESERVED(),await this._RESERVEDtoEXCLUSIVE()}async _SHAREDtoRESERVED(){}async _RESERVEDtoEXCLUSIVE(){}async _EXCLUSIVEtoRESERVED(){}async _EXCLUSIVEtoSHARED(){await this._EXCLUSIVEtoRESERVED(),await this._RESERVEDtoSHARED()}async _EXCLUSIVEtoNONE(){await this._EXCLUSIVEtoRESERVED(),await this._RESERVEDtoSHARED(),await this._SHAREDtoNONE()}async _RESERVEDtoSHARED(){}async _RESERVEDtoNONE(){await this._RESERVEDtoSHARED(),await this._SHAREDtoNONE()}async _SHAREDtoNONE(){}_acquireWebLock(e,t){return new Promise(async(r,s)=>{try{await navigator.locks.request(e,t,n=>{if(r(n),n)return new Promise(a=>this.#r.set(e,a))})}catch(n){s(n)}})}_releaseWebLock(e){this.#r.get(e)?.(),this.#r.delete(e)}async _pollWebLock(e){return(await navigator.locks.query()).held.find(({name:r})=>r===e)?.mode}_getTimeoutSignal(){if(this.timeoutMillis){const e=new AbortController;return setTimeout(()=>e.abort(),this.timeoutMillis),e.signal}}}class j extends X{constructor(e){super(),this._lockName=e+"-outer",this._reservedName=e+"-reserved"}async isSomewhereReserved(){return await this._pollWebLock(this._reservedName)==="exclusive"}async _NONEtoSHARED(){await this._acquireWebLock(this._lockName,{mode:"exclusive",signal:this._getTimeoutSignal()})}async _SHAREDtoRESERVED(){await this._acquireWebLock(this._reservedName,{mode:"exclusive",signal:this._getTimeoutSignal()})}async _RESERVEDtoSHARED(){this._releaseWebLock(this._reservedName)}async _SHAREDtoNONE(){this._releaseWebLock(this._lockName)}}const q=5e3;let F=0;const k=new WeakMap;function g(...l){}class Y{#e;#r;#t;#s=null;#i=0;#a=Promise.resolve();#n=Promise.resolve();constructor(e,t={durability:"default"}){this.#r=Promise.resolve(e).then(r=>this.#e=r),this.#t=t}async close(){const e=this.#e??await this.#r;await this.#a,await this.sync(),e.close()}async run(e,t){const r=this.#a.then(()=>this.#c(e,t));return this.#a=r.catch(()=>{}),r}async#c(e,t){const r=this.#e??await this.#r;if(e==="readwrite"&&this.#s?.mode==="readonly")this.#s=null;else if(performance.now()-this.#i>q){try{this.#s?.commit()}catch(s){if(s.name!=="InvalidStateError")throw s}await new Promise(s=>setTimeout(s)),this.#s=null}for(let s=0;s<2;++s){if(!this.#s){this.#s=r.transaction(r.objectStoreNames,e,this.#t);const n=this.#i=performance.now();this.#n=this.#n.then(()=>new Promise((a,i)=>{this.#s.addEventListener("complete",h=>{a(),this.#s===h.target&&(this.#s=null),g(`transaction ${k.get(h.target)} complete`)}),this.#s.addEventListener("abort",h=>{console.warn("tx abort",(performance.now()-n)/1e3);const u=h.target.error;i(u),this.#s===h.target&&(this.#s=null),g(`transaction ${k.get(h.target)} aborted`,u)})})),k.set(this.#s,F++)}try{const n=Object.fromEntries(Array.from(r.objectStoreNames,a=>[a,new G(this.#s.objectStore(a))]));return await t(n)}catch(n){if(this.#s=null,s)throw n}}}async sync(){await this.#a,await this.#n,this.#n=Promise.resolve()}}function b(l){return new Promise((e,t)=>{l.addEventListener("success",()=>e(l.result)),l.addEventListener("error",()=>t(l.error))})}class G{#e;constructor(e){this.#e=e}get(e){g(`get ${this.#e.name}`,e);const t=this.#e.get(e);return b(t)}getAll(e,t){g(`getAll ${this.#e.name}`,e,t);const r=this.#e.getAll(e,t);return b(r)}getKey(e){g(`getKey ${this.#e.name}`,e);const t=this.#e.getKey(e);return b(t)}getAllKeys(e,t){g(`getAllKeys ${this.#e.name}`,e,t);const r=this.#e.getAllKeys(e,t);return b(r)}put(e,t){g(`put ${this.#e.name}`,e,t);const r=this.#e.put(e,t);return b(r)}delete(e){g(`delete ${this.#e.name}`,e);const t=this.#e.delete(e);return b(t)}clear(){g(`clear ${this.#e.name}`);const e=this.#e.clear();return b(e)}index(e){return new Z(this.#e.index(e))}}class Z{#e;constructor(e){this.#e=e}getAllKeys(e,t){g(`IDBIndex.getAllKeys ${this.#e.objectStore.name}<${this.#e.name}>`,e,t);const r=this.#e.getAllKeys(e,t);return b(r)}}const J=512,C=3e3,D={durability:"default",purge:"deferred",purgeAtLeast:16};function E(...l){}class se extends Q{#e;#r=new Map;#t;#s=new Set;#i=performance.now();#a=new Set;#n=null;constructor(e="wa-sqlite",t=D){super(),this.name=e,this.#e=Object.assign({},D,t),this.#t=new Y(ee(e),{durability:this.#e.durability})}async close(){for(const e of this.#r.keys())await this.xClose(e);await this.#t?.close(),this.#t=null}xOpen(e,t,r,s){const n=this.handleAsync(async()=>{e===null&&(e=`null_${t}`),E(`xOpen ${e} 0x${t.toString(16)} 0x${r.toString(16)}`);try{const a=new URL(e,"http://localhost/"),i={path:a.pathname,flags:r,block0:null,isMetadataChanged:!0,locks:new j(a.pathname)};return this.#r.set(t,i),await this.#t.run("readwrite",async({blocks:h})=>{if(i.block0=await h.get(this.#o(i,0)),!i.block0)if(r&O)i.block0={path:i.path,offset:0,version:0,data:new Uint8Array(0),fileSize:0},h.put(i.block0);else throw new Error(`file not found: ${i.path}`)}),(s.buffer.detached||!s.buffer.byteLength)&&(s=new DataView(new ArrayBuffer(4)),this.#n=h=>{h.setInt32(0,s.getInt32(0,!0),!0)}),s.setInt32(0,r&V,!0),o}catch(a){return console.error(a),T}});return this.#n?.(s),this.#n=null,n}xClose(e){return this.handleAsync(async()=>{try{const t=this.#r.get(e);return t&&(E(`xClose ${t.path}`),this.#r.delete(e),t.flags&H&&this.#t.run("readwrite",({blocks:r})=>{r.delete(IDBKeyRange.bound([t.path],[t.path,[]]))})),o}catch(t){return console.error(t),c}})}xRead(e,t,r){const s=t.byteLength,n=this.handleAsync(async()=>{const a=this.#r.get(e);E(`xRead ${a.path} ${t.byteLength} ${r}`);try{return await this.#t.run("readonly",async({blocks:h})=>{(t.buffer.detached||!t.buffer.byteLength)&&(t=new Uint8Array(s),this.#n=y=>y.set(t));let u=0;for(;u<t.byteLength;){const y=r+u,d=y<a.block0.data.byteLength?a.block0:await h.get(this.#o(a,-y));if(!d||d.data.byteLength-d.offset<=y)return t.fill(0,u),K;const A=t.subarray(u),f=y+d.offset,_=Math.min(Math.max(d.data.byteLength-f,0),A.byteLength);A.set(d.data.subarray(f,f+_)),u+=_}return o})}catch(i){return console.error(i),c}});return this.#n?.(t),this.#n=null,n}xWrite(e,t,r){const s=this.#a.has(e);if(s||performance.now()-this.#i>C){const n=this.handleAsync(async()=>{this.handleAsync!==super.handleAsync&&this.#a.add(e),await new Promise(i=>setTimeout(i));const a=this.#c(e,t.slice(),r);return this.#i=performance.now(),a});return s&&this.#a.delete(e),n}return this.#c(e,t,r)}#c(e,t,r){const s=this.#r.get(e);E(`xWrite ${s.path} ${t.byteLength} ${r}`);try{const n=s.block0.fileSize;s.block0.fileSize<r+t.byteLength&&(s.block0.fileSize=r+t.byteLength,s.isMetadataChanged=!0);const a=r===0?s.block0:{path:s.path,offset:-r,version:s.block0.version,data:null};return a.data=t.slice(),s.changedPages?(n===s.block0.fileSize&&s.changedPages.add(-r),r!==0&&this.#t.run("readwrite",({blocks:i})=>i.put(a))):this.#t.run("readwrite",({blocks:i})=>i.put(a)),s.isMetadataChanged=r===0?!1:s.isMetadataChanged,o}catch(n){return console.error(n),c}}xTruncate(e,t){const r=this.#r.get(e);E(`xTruncate ${r.path} ${t}`);try{Object.assign(r.block0,{fileSize:t,data:r.block0.data.slice(0,t)});const s=Object.assign({},r.block0);return this.#t.run("readwrite",({blocks:n})=>{n.delete(this.#o(r,-1/0,-t)),n.put(s)}),o}catch(s){return console.error(s),c}}xSync(e,t){const r=this.#a.has(e);if(r||this.#e.durability!=="relaxed"||performance.now()-this.#i>C){const n=this.handleAsync(async()=>{this.handleAsync!==super.handleAsync&&this.#a.add(e);const a=await this.#h(e,t);return this.#i=performance.now(),a});return r&&this.#a.delete(e),n}const s=this.#r.get(e);return E(`xSync ${s.path} ${t}`),o}async#h(e,t){const r=this.#r.get(e);E(`xSync ${r.path} ${t}`);try{r.isMetadataChanged&&(this.#t.run("readwrite",async({blocks:s})=>{await s.put(r.block0)}),r.isMetadataChanged=!1),await this.#t.sync()}catch(s){return console.error(s),c}return o}xFileSize(e,t){const r=this.#r.get(e);return E(`xFileSize ${r.path}`),t.setBigInt64(0,BigInt(r.block0.fileSize),!0),o}xLock(e,t){return this.handleAsync(async()=>{const r=this.#r.get(e);E(`xLock ${r.path} ${t}`);try{const s=await r.locks.lock(t);return s===o&&r.locks.state===p&&(r.block0=await this.#t.run("readonly",({blocks:n})=>n.get(this.#o(r,0)))),s}catch(s){return console.error(s),c}})}xUnlock(e,t){return this.handleAsync(async()=>{const r=this.#r.get(e);E(`xUnlock ${r.path} ${t}`);try{return r.locks.unlock(t)}catch(s){return console.error(s),c}})}xCheckReservedLock(e,t){const r=this.handleAsync(async()=>{const s=this.#r.get(e);E(`xCheckReservedLock ${s.path}`);const n=await s.locks.isSomewhereReserved();return(t.buffer.detached||!t.buffer.byteLength)&&(t=new DataView(new ArrayBuffer(4)),this.#n=a=>{a.setInt32(0,t.getInt32(0,!0),!0)}),t.setInt32(0,n?1:0,!0),o});return this.#n?.(t),this.#n=null,r}xSectorSize(e){return J}xDeviceCharacteristics(e){return U|M|B|z}xFileControl(e,t,r){const s=this.#r.get(e);switch(E(`xFileControl ${s.path} ${t}`),t){case 11:return s.overwrite=!0,o;case 21:if(s.overwrite)try{return this.handleAsync(async()=>(await this.#u(s),o))}catch(n){return console.error(n),c}if(s.isMetadataChanged)try{this.#t.run("readwrite",async({blocks:n})=>{await n.put(s.block0)}),s.isMetadataChanged=!1}catch(n){return console.error(n),c}return o;case 22:return s.overwrite=!1,o;case 31:return this.handleAsync(async()=>{try{return s.block0.version--,s.changedPages=new Set,this.#t.run("readwrite",async({blocks:n})=>{const a=await n.index("version").getAllKeys(IDBKeyRange.bound([s.path],[s.path,s.block0.version]));for(const i of a)n.delete(i)}),o}catch(n){return console.error(n),c}});case 32:try{const n=Object.assign({},s.block0);n.data=n.data.slice();const a=s.changedPages;return s.changedPages=null,s.isMetadataChanged=!1,this.#t.run("readwrite",async({blocks:i})=>{i.put(n);const h=await i.get([s.path,"purge",0])??{path:s.path,offset:"purge",version:0,data:new Map,count:0};h.count+=a.size;for(const u of a)h.data.set(u,n.version);i.put(h),this.#l(s.path,h.count)}),o}catch(n){return console.error(n),c}case 33:return this.handleAsync(async()=>{try{return s.changedPages=null,s.isMetadataChanged=!1,s.block0=await this.#t.run("readonly",({blocks:n})=>n.get([s.path,0,s.block0.version+1])),o}catch(n){return console.error(n),c}});default:return $}}xAccess(e,t,r){const s=this.handleAsync(async()=>{try{const n=new URL(e,"file://localhost/").pathname;E(`xAccess ${n} ${t}`);const a=await this.#t.run("readonly",({blocks:i})=>i.getKey(this.#o({path:n},0)));return(r.buffer.detached||!r.buffer.byteLength)&&(r=new DataView(new ArrayBuffer(4)),this.#n=i=>{i.setInt32(0,r.getInt32(0,!0),!0)}),r.setInt32(0,a?1:0,!0),o}catch(n){return console.error(n),c}});return this.#n?.(r),this.#n=null,s}xDelete(e,t){return this.handleAsync(async()=>{const r=new URL(e,"file://localhost/").pathname;try{return this.#t.run("readwrite",({blocks:s})=>s.delete(IDBKeyRange.bound([r],[r,[]]))),t&&await this.#t.sync(),o}catch(s){return console.error(s),c}})}async purge(e){const t=Date.now();await this.#t.run("readwrite",async({blocks:r})=>{const s=await r.get([e,"purge",0]);if(s){for(const[n,a]of s.data)r.delete(IDBKeyRange.bound([e,n,a],[e,n,1/0],!0,!1));await r.delete([e,"purge",0])}E(`purge ${e} ${s?.data.size??0} pages in ${Date.now()-t} ms`)})}#l(e,t){this.#e.purge==="manual"||this.#s.has(e)||t<this.#e.purgeAtLeast||(globalThis.requestIdleCallback?globalThis.requestIdleCallback(()=>{this.purge(e),this.#s.delete(e)}):setTimeout(()=>{this.purge(e),this.#s.delete(e)}),this.#s.add(e))}#o(e,t,r=0){const s=!t||-t<e.block0.data.length?-1/0:e.block0.version;return IDBKeyRange.bound([e.path,t,s],[e.path,r,1/0])}async#u(e){const t=e.block0.data.length;if(t<18)return;const r=new DataView(e.block0.data.buffer,e.block0.data.byteOffset);let s=r.getUint16(16);if(s===1&&(s=65536),s===t)return;const n=Math.max(t,s),a=n/t,i=n/s,u=r.getUint32(28)*s,y=e.block0.version;await this.#t.run("readwrite",async({blocks:d})=>{const A=await d.index("version").getAllKeys(IDBKeyRange.bound([e.path,y+1],[e.path,1/0]));for(const f of A)d.delete(f);d.delete([e.path,"purge",0]);for(let f=0;f<u;f+=n){const _=await d.getAll(IDBKeyRange.lowerBound([e.path,-(f+n),1/0]),a);for(const S of _)d.delete([S.path,S.offset,S.version]);if(i===1){const S=new Uint8Array(s);for(const L of _)S.set(L.data,-(f+L.offset));const w={path:e.path,offset:-f,version:y,data:S};w.offset===0&&(w.fileSize=u,e.block0=w),d.put(w)}else{const S=_[0];for(let w=0;w<i;++w){const L=-(f+w*s);if(-L>=u)break;const m={path:S.path,offset:L,version:y,data:S.data.subarray(w*s,(w+1)*s)};m.offset===0&&(m.fileSize=u,e.block0=m),d.put(m)}}}})}}function ee(l){return new Promise((e,t)=>{const r=globalThis.indexedDB.open(l,5);r.addEventListener("upgradeneeded",function(){r.result.createObjectStore("blocks",{keyPath:["path","offset","version"]}).createIndex("version",["path","version"])}),r.addEventListener("success",()=>{e(r.result)}),r.addEventListener("error",()=>{t(r.error)})})}export{se as IDBBatchAtomicVFS};
