let Qn,An,xn,Nn,Pn,On,Rn,Dn,Hn,Bn,Wn,Un,kn,Cn,vn,Kn,Fn,zn,Gn;let __tla=(async()=>{An=0;On=5;Qn=10;xn=12;Nn=14;Rn=3850;vn=522;kn=1;Un=4;Cn=8;Pn=0;Bn=1;Dn=2;Wn=3;Hn=4;Fn=512;zn=1024;Gn=2048;Kn=16384;typeof BigInt.prototype.toJSON>"u"&&(BigInt.prototype.toJSON=function(){return this.toString()});const K=0x7fffffffffffffffn,V=-0x8000000000000000n;class O extends Error{constructor(n,i){super(n),this.code=i}}const R=!0,X={};globalThis.__onTablesChanged=function(t,n,i,h){setTimeout(()=>X[t]?.(n,i,h),0)};function rn(t){const n={},i=t._getSqliteFree(),h=t._malloc(8),a=[h,h+4];function E(s){if(typeof s!="string")return 0;const r=t.lengthBytesUTF8(s),e=t._sqlite3_malloc(r+1);return t.stringToUTF8(s,e,r+1),e}function m(s,r){return BigInt(r)<<32n|BigInt(s)&4294967295n}const g=function(){const s=BigInt(Number.MAX_SAFE_INTEGER)>>32n,r=BigInt(Number.MIN_SAFE_INTEGER)>>32n;return function(e,c){return c>s||c<r?m(e,c):c*4294967296+(e&2147483647)-(e&2147483648)}}(),b=new Set;function w(s){if(!b.has(s))throw new O("not a database",21)}const f=new Map;function l(s){if(!f.has(s))throw new O("not a statement",21)}n.bind_collection=function(s,r){l(s);const e=Array.isArray(r),c=n.bind_parameter_count(s);for(let o=1;o<=c;++o){const u=e?o-1:n.bind_parameter_name(s,o),p=r[u];p!==void 0&&n.bind(s,o,p)}return 0},n.bind=function(s,r,e){switch(l(s),typeof e){case"number":return e===(e|0)?n.bind_int(s,r,e):n.bind_double(s,r,e);case"string":return n.bind_text(s,r,e);default:return e instanceof Uint8Array||Array.isArray(e)?n.bind_blob(s,r,e):e===null?n.bind_null(s,r):typeof e=="bigint"?n.bind_int64(s,r,e):e===void 0?27:(console.warn("unknown binding converted to null",e),n.bind_null(s,r))}},n.bind_blob=function(){const s="sqlite3_bind_blob",r=t.cwrap(s,..._("nnnnn:n"));return function(e,c,o){l(e);const u=o.byteLength??o.length,p=t._sqlite3_malloc(u);t.HEAPU8.subarray(p).set(o);const L=r(e,c,p,u,i);return y(s,L,f.get(e))}}(),n.bind_parameter_count=function(){const r=t.cwrap("sqlite3_bind_parameter_count",..._("n:n"));return function(e){return l(e),r(e)}}(),n.bind_double=function(){const s="sqlite3_bind_double",r=t.cwrap(s,..._("nnn:n"));return function(e,c,o){l(e);const u=r(e,c,o);return y(s,u,f.get(e))}}(),n.bind_int=function(){const s="sqlite3_bind_int",r=t.cwrap(s,..._("nnn:n"));return function(e,c,o){if(l(e),o>2147483647||o<-2147483648)return 25;const u=r(e,c,o);return y(s,u,f.get(e))}}(),n.bind_int64=function(){const s="sqlite3_bind_int64",r=t.cwrap(s,..._("nnnn:n"));return function(e,c,o){if(l(e),o>K||o<V)return 25;const u=o&4294967295n,p=o>>32n,L=r(e,c,Number(u),Number(p));return y(s,L,f.get(e))}}(),n.bind_null=function(){const s="sqlite3_bind_null",r=t.cwrap(s,..._("nn:n"));return function(e,c){l(e);const o=r(e,c);return y(s,o,f.get(e))}}(),n.bind_parameter_name=function(){const r=t.cwrap("sqlite3_bind_parameter_name",..._("n:s"));return function(e,c){return l(e),r(e,c)}}(),n.bind_text=function(){const s="sqlite3_bind_text",r=t.cwrap(s,..._("nnnnn:n"));return function(e,c,o){l(e);const u=E(o),p=r(e,c,u,-1,i);return y(s,p,f.get(e))}}(),n.changes=function(){const r=t.cwrap("sqlite3_changes",..._("n:n"));return function(e){return w(e),r(e)}}(),n.last_insert_id=function(){const r=t.cwrap("sqlite3_last_insert_rowid",..._("n:n"));return function(e){return w(e),r(e)}}(),n.close=function(){const s="sqlite3_close",r=t.cwrap(s,..._("n:n"),{async:R});return async function(e){w(e);const c=await r(e);return b.delete(e),y(s,c,e)}}(),n.column=function(s,r){l(s);const e=n.column_type(s,r);switch(e){case 4:return n.column_blob(s,r);case 2:return n.column_double(s,r);case 1:const c=n.column_int(s,r),o=t.getTempRet0();return g(c,o);case 5:return null;case 3:return n.column_text(s,r);default:throw new O("unknown type",e)}},n.column_blob=function(){const r=t.cwrap("sqlite3_column_blob",..._("nn:n"));return function(e,c){l(e);const o=n.column_bytes(e,c),u=r(e,c);return t.HEAPU8.subarray(u,u+o)}}(),n.column_bytes=function(){const r=t.cwrap("sqlite3_column_bytes",..._("nn:n"));return function(e,c){return l(e),r(e,c)}}(),n.column_count=function(){const r=t.cwrap("sqlite3_column_count",..._("n:n"));return function(e){return l(e),r(e)}}(),n.column_double=function(){const r=t.cwrap("sqlite3_column_double",..._("nn:n"));return function(e,c){return l(e),r(e,c)}}(),n.column_int=function(){const r=t.cwrap("sqlite3_column_int64",..._("nn:n"));return function(e,c){return l(e),r(e,c)}}(),n.column_int64=function(){const r=t.cwrap("sqlite3_column_int64",..._("nn:n"));return function(e,c){l(e);const o=r(e,c),u=t.getTempRet0();return m(o,u)}}(),n.column_name=function(){const r=t.cwrap("sqlite3_column_name",..._("nn:s"));return function(e,c){return l(e),r(e,c)}}(),n.column_names=function(s){const r=[],e=n.column_count(s);for(let c=0;c<e;++c)r.push(n.column_name(s,c));return r},n.column_text=function(){const r=t.cwrap("sqlite3_column_text",..._("nn:s"));return function(e,c){return l(e),r(e,c)}}(),n.column_type=function(){const r=t.cwrap("sqlite3_column_type",..._("nn:n"));return function(e,c){return l(e),r(e,c)}}(),n.create_function=function(s,r,e,c,o,u,p,L){if(w(s),u&&!p&&!L){const S=t.createFunction(s,r,e,c,o,u);return y("sqlite3_create_function",S,s)}if(!u&&p&&L){const S=t.createAggregate(s,r,e,c,o,p,L);return y("sqlite3_create_function",S,s)}throw new O("invalid function combination",21)},n.create_module=function(s,r,e,c){w(s);const o=t.createModule(s,r,e,c);return y("sqlite3_create_module",o,s)},n.data_count=function(){const r=t.cwrap("sqlite3_data_count",..._("n:n"));return function(e){return l(e),r(e)}}(),n.declare_vtab=function(){const r=t.cwrap("sqlite3_declare_vtab",..._("ns:n"));return function(e,c){const o=r(e,c);return y("sqlite3_declare_vtab",o)}}(),n.exec=async function(s,r,e){for await(const c of n.statements(s,r)){let o;for(;await n.step(c)===100;)if(e){o=o??n.column_names(c);const u=n.row(c);await e(u,o)}}return 0},n.finalize=function(){const r=t.cwrap("sqlite3_finalize",..._("n:n"),{async:R});return async function(e){if(!f.has(e))return 21;const c=await r(e);return f.get(e),f.delete(e),c}}(),n.get_autocommit=function(){const r=t.cwrap("sqlite3_get_autocommit",..._("n:n"));return function(e){return r(e)}}(),n.libversion=function(){const r=t.cwrap("sqlite3_libversion",..._(":s"));return function(){return r()}}(),n.libversion_number=function(){const r=t.cwrap("sqlite3_libversion_number",..._(":n"));return function(){return r()}}(),n.limit=function(){const r=t.cwrap("sqlite3_limit",..._("nnn:n"));return function(e,c,o){return r(e,c,o)}}(),n.open_v2=function(){const s="sqlite3_open_v2",r=t.cwrap(s,..._("snnn:n"),{async:R});return async function(e,c,o){c=c||6,o=E(o),t.ccall("setup_powersync","int",[]);const u=await r(e,a[0],c,o),p=t.getValue(a[0],"*");return b.add(p),t._sqlite3_free(o),t.ccall("RegisterExtensionFunctions","void",["number"],[p]),y(s,u),p}}(),n.register_table_onchange_hook=function(s,r){t.ccall("register_table_update_hook","int",["number"],[s]),X[s]=function(e,c,o){const u=new DataView(t.HEAPU8.buffer);let p=0;for(;u.getUint8(c+p)!==0;)p++;const L=new Uint8Array(t.HEAPU8.buffer,c,p),S=new TextDecoder().decode(L);return r(e,S,o)}},n.prepare_v2=function(){const s="sqlite3_prepare_v2",r=t.cwrap(s,..._("nnnnn:n"),{async:R});return async function(e,c){const o=await r(e,c,-1,a[0],a[1]);y(s,o,e);const u=t.getValue(a[0],"*");return u?(f.set(u,e),{stmt:u,sql:t.getValue(a[1],"*")}):null}}(),n.progress_handler=function(s,r,e,c){w(s),t.progressHandler(s,r,e,c)},n.reset=function(){const s="sqlite3_reset",r=t.cwrap(s,..._("n:n"),{async:R});return async function(e){l(e);const c=await r(e);return y(s,c,f.get(e))}}(),n.result=function(s,r){switch(typeof r){case"number":r===(r|0)?n.result_int(s,r):n.result_double(s,r);break;case"string":n.result_text(s,r);break;default:if(r instanceof Uint8Array||Array.isArray(r))n.result_blob(s,r);else if(r===null)n.result_null(s);else{if(typeof r=="bigint")return n.result_int64(s,r);console.warn("unknown result converted to null",r),n.result_null(s)}break}},n.result_blob=function(){const r=t.cwrap("sqlite3_result_blob",..._("nnnn:n"));return function(e,c){const o=c.byteLength??c.length,u=t._sqlite3_malloc(o);t.HEAPU8.subarray(u).set(c),r(e,u,o,i)}}(),n.result_double=function(){const r=t.cwrap("sqlite3_result_double",..._("nn:n"));return function(e,c){r(e,c)}}(),n.result_int=function(){const r=t.cwrap("sqlite3_result_int",..._("nn:n"));return function(e,c){r(e,c)}}(),n.result_int64=function(){const r=t.cwrap("sqlite3_result_int64",..._("nnn:n"));return function(e,c){if(c>K||c<V)return 25;const o=c&4294967295n,u=c>>32n;r(e,Number(o),Number(u))}}(),n.result_null=function(){const r=t.cwrap("sqlite3_result_null",..._("n:n"));return function(e){r(e)}}(),n.result_text=function(){const r=t.cwrap("sqlite3_result_text",..._("nnnn:n"));return function(e,c){const o=E(c);r(e,o,-1,i)}}(),n.row=function(s){const r=[],e=n.data_count(s);for(let c=0;c<e;++c){const o=n.column(s,c);r.push(o?.buffer===t.HEAPU8.buffer?o.slice():o)}return r},n.set_authorizer=function(s,r,e){w(s);const c=t.setAuthorizer(s,r,e);return y("sqlite3_set_authorizer",c,s)},n.sql=function(){const r=t.cwrap("sqlite3_sql",..._("n:s"));return function(e){return l(e),r(e)}}(),n.statements=function(s,r){return async function*(){const e=n.str_new(s,r);let c={stmt:null,sql:n.str_value(e)};try{for(;c=await n.prepare_v2(s,c.sql);)yield c.stmt,n.finalize(c.stmt),c.stmt=null}finally{c?.stmt&&n.finalize(c.stmt),n.str_finish(e)}}()},n.step=function(){const s="sqlite3_step",r=t.cwrap(s,..._("n:n"),{async:R});return async function(e){l(e);const c=await r(e);return y(s,c,f.get(e),[100,101])}}();let d=0;const T=new Map;n.str_new=function(s,r=""){const e=t.lengthBytesUTF8(r),c=d++&4294967295,o={offset:t._sqlite3_malloc(e+1),bytes:e};return T.set(c,o),t.stringToUTF8(r,o.offset,o.bytes+1),c},n.str_appendall=function(s,r){if(!T.has(s))throw new O("not a string",21);const e=T.get(s),c=t.lengthBytesUTF8(r),o=e.bytes+c,u=t._sqlite3_malloc(o+1);t.HEAPU8.subarray(u,u+o+1).set(t.HEAPU8.subarray(e.offset,e.offset+e.bytes)),t.stringToUTF8(r,u+e.bytes,c+1),t._sqlite3_free(e.offset),e.offset=u,e.bytes=o,T.set(s,e)},n.str_finish=function(s){if(!T.has(s))throw new O("not a string",21);const r=T.get(s);T.delete(s),t._sqlite3_free(r.offset)},n.str_value=function(s){if(!T.has(s))throw new O("not a string",21);return T.get(s).offset},n.user_data=function(s){return t.getFunctionUserData(s)},n.value=function(s){const r=n.value_type(s);switch(r){case 4:return n.value_blob(s);case 2:return n.value_double(s);case 1:const e=n.value_int(s),c=t.getTempRet0();return g(e,c);case 5:return null;case 3:return n.value_text(s);default:throw new O("unknown type",r)}},n.value_blob=function(){const r=t.cwrap("sqlite3_value_blob",..._("n:n"));return function(e){const c=n.value_bytes(e),o=r(e);return t.HEAPU8.subarray(o,o+c)}}(),n.value_bytes=function(){const r=t.cwrap("sqlite3_value_bytes",..._("n:n"));return function(e){return r(e)}}(),n.value_double=function(){const r=t.cwrap("sqlite3_value_double",..._("n:n"));return function(e){return r(e)}}(),n.value_int=function(){const r=t.cwrap("sqlite3_value_int64",..._("n:n"));return function(e){return r(e)}}(),n.value_int64=function(){const r=t.cwrap("sqlite3_value_int64",..._("n:n"));return function(e){const c=r(e),o=t.getTempRet0();return m(c,o)}}(),n.value_text=function(){const r=t.cwrap("sqlite3_value_text",..._("n:s"));return function(e){return r(e)}}(),n.value_type=function(){const r=t.cwrap("sqlite3_value_type",..._("n:n"));return function(e){return r(e)}}(),n.vfs_register=function(s,r){const e=t.registerVFS(s,r);return y("sqlite3_vfs_register",e)};function y(s,r,e=null,c=[0]){if(c.includes(r))return r;const o=e?t.ccall("sqlite3_errmsg","string",["number"],[e]):s;throw new O(o,r)}return n}function _(t){const n=[],i=t.match(/([ns@]*):([nsv@])/);switch(i[2]){case"n":n.push("number");break;case"s":n.push("string");break;case"v":n.push(null);break}const h=[];for(let a of i[1])switch(a){case"n":h.push("number");break;case"s":h.push("string");break}return n.push(h),n}const Y=Symbol("Comlink.proxy"),sn=Symbol("Comlink.endpoint"),cn=Symbol("Comlink.releaseProxy"),F=Symbol("Comlink.finalizer"),B=Symbol("Comlink.thrown"),J=t=>typeof t=="object"&&t!==null||typeof t=="function",on={canHandle:t=>J(t)&&t[Y],serialize(t){const{port1:n,port2:i}=new MessageChannel;return G(t,n),[i,[i]]},deserialize(t){return t.start(),ln(t)}},an={canHandle:t=>J(t)&&B in t,serialize({value:t}){let n;return t instanceof Error?n={isError:!0,value:{message:t.message,name:t.name,stack:t.stack}}:n={isError:!1,value:t},[n,[]]},deserialize(t){throw t.isError?Object.assign(new Error(t.value.message),t.value):t.value}},Z=new Map([["proxy",on],["throw",an]]);function un(t,n){for(const i of t)if(n===i||i==="*"||i instanceof RegExp&&i.test(n))return!0;return!1}function G(t,n=globalThis,i=["*"]){n.addEventListener("message",function h(a){if(!a||!a.data)return;if(!un(i,a.origin)){console.warn(`Invalid origin '${a.origin}' for comlink proxy`);return}const{id:E,type:m,path:g}=Object.assign({path:[]},a.data),b=(a.data.argumentList||[]).map(x);let w;try{const f=g.slice(0,-1).reduce((d,T)=>d[T],t),l=g.reduce((d,T)=>d[T],t);switch(m){case"GET":w=l;break;case"SET":f[g.slice(-1)[0]]=x(a.data.value),w=!0;break;case"APPLY":w=l.apply(f,b);break;case"CONSTRUCT":{const d=new l(...b);w=Q(d)}break;case"ENDPOINT":{const{port1:d,port2:T}=new MessageChannel;G(t,T),w=mn(d,[d])}break;case"RELEASE":w=void 0;break;default:return}}catch(f){w={value:f,[B]:0}}Promise.resolve(w).catch(f=>({value:f,[B]:0})).then(f=>{const[l,d]=H(f);n.postMessage(Object.assign(Object.assign({},l),{id:E}),d),m==="RELEASE"&&(n.removeEventListener("message",h),M(n),F in t&&typeof t[F]=="function"&&t[F]())}).catch(f=>{const[l,d]=H({value:new TypeError("Unserializable return value"),[B]:0});n.postMessage(Object.assign(Object.assign({},l),{id:E}),d)})}),n.start&&n.start()}function fn(t){return t.constructor.name==="MessagePort"}function M(t){fn(t)&&t.close()}function ln(t,n){return z(t,[],n)}function P(t){if(t)throw new Error("Proxy has been released and is not useable")}function nn(t){return v(t,{type:"RELEASE"}).then(()=>{M(t)})}const D=new WeakMap,W="FinalizationRegistry"in globalThis&&new FinalizationRegistry(t=>{const n=(D.get(t)||0)-1;D.set(t,n),n===0&&nn(t)});function _n(t,n){const i=(D.get(n)||0)+1;D.set(n,i),W&&W.register(t,n,t)}function hn(t){W&&W.unregister(t)}function z(t,n=[],i=function(){}){let h=!1;const a=new Proxy(i,{get(E,m){if(P(h),m===cn)return()=>{hn(a),nn(t),h=!0};if(m==="then"){if(n.length===0)return{then:()=>a};const g=v(t,{type:"GET",path:n.map(b=>b.toString())}).then(x);return g.then.bind(g)}return z(t,[...n,m])},set(E,m,g){P(h);const[b,w]=H(g);return v(t,{type:"SET",path:[...n,m].map(f=>f.toString()),value:b},w).then(x)},apply(E,m,g){P(h);const b=n[n.length-1];if(b===sn)return v(t,{type:"ENDPOINT"}).then(x);if(b==="bind")return z(t,n.slice(0,-1));const[w,f]=$(g);return v(t,{type:"APPLY",path:n.map(l=>l.toString()),argumentList:w},f).then(x)},construct(E,m){P(h);const[g,b]=$(m);return v(t,{type:"CONSTRUCT",path:n.map(w=>w.toString()),argumentList:g},b).then(x)}});return _n(a,t),a}function wn(t){return Array.prototype.concat.apply([],t)}function $(t){const n=t.map(H);return[n.map(i=>i[0]),wn(n.map(i=>i[1]))]}const tn=new WeakMap;function mn(t,n){return tn.set(t,n),t}function Q(t){return Object.assign(t,{[Y]:!0})}function H(t){for(const[n,i]of Z)if(i.canHandle(t)){const[h,a]=i.serialize(t);return[{type:"HANDLER",name:n,value:h},a]}return[{type:"RAW",value:t},tn.get(t)||[]]}function x(t){switch(t.type){case"HANDLER":return Z.get(t.name).deserialize(t.value);case"RAW":return t.value}}function v(t,n,i){return new Promise(h=>{const a=En();t.addEventListener("message",function E(m){!m.data||!m.data.id||m.data.id!==a||(t.removeEventListener("message",E),h(m.data))}),t.start&&t.start(),t.postMessage(Object.assign({id:a},n),i)})}function En(){return new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-")}const pn=new Error("request for lock canceled");var gn=function(t,n,i,h){function a(E){return E instanceof i?E:new i(function(m){m(E)})}return new(i||(i=Promise))(function(E,m){function g(f){try{w(h.next(f))}catch(l){m(l)}}function b(f){try{w(h.throw(f))}catch(l){m(l)}}function w(f){f.done?E(f.value):a(f.value).then(g,b)}w((h=h.apply(t,n||[])).next())})};class bn{constructor(n,i=pn){this._value=n,this._cancelError=i,this._weightedQueues=[],this._weightedWaiters=[]}acquire(n=1){if(n<=0)throw new Error(`invalid weight ${n}: must be positive`);return new Promise((i,h)=>{this._weightedQueues[n-1]||(this._weightedQueues[n-1]=[]),this._weightedQueues[n-1].push({resolve:i,reject:h}),this._dispatch()})}runExclusive(n,i=1){return gn(this,void 0,void 0,function*(){const[h,a]=yield this.acquire(i);try{return yield n(h)}finally{a()}})}waitForUnlock(n=1){if(n<=0)throw new Error(`invalid weight ${n}: must be positive`);return new Promise(i=>{this._weightedWaiters[n-1]||(this._weightedWaiters[n-1]=[]),this._weightedWaiters[n-1].push(i),this._dispatch()})}isLocked(){return this._value<=0}getValue(){return this._value}setValue(n){this._value=n,this._dispatch()}release(n=1){if(n<=0)throw new Error(`invalid weight ${n}: must be positive`);this._value+=n,this._dispatch()}cancel(){this._weightedQueues.forEach(n=>n.forEach(i=>i.reject(this._cancelError))),this._weightedQueues=[]}_dispatch(){var n;for(let i=this._value;i>0;i--){const h=(n=this._weightedQueues[i-1])===null||n===void 0?void 0:n.shift();if(!h)continue;const a=this._value,E=i;this._value-=i,i=this._value+1,h.resolve([a,this._newReleaser(E)])}this._drainUnlockWaiters()}_newReleaser(n){let i=!1;return()=>{i||(i=!0,this.release(n))}}_drainUnlockWaiters(){for(let n=this._value;n>0;n--)this._weightedWaiters[n-1]&&(this._weightedWaiters[n-1].forEach(i=>i()),this._weightedWaiters[n-1]=[])}}var yn=function(t,n,i,h){function a(E){return E instanceof i?E:new i(function(m){m(E)})}return new(i||(i=Promise))(function(E,m){function g(f){try{w(h.next(f))}catch(l){m(l)}}function b(f){try{w(h.throw(f))}catch(l){m(l)}}function w(f){f.done?E(f.value):a(f.value).then(g,b)}w((h=h.apply(t,n||[])).next())})};class Tn{constructor(n){this._semaphore=new bn(1,n)}acquire(){return yn(this,void 0,void 0,function*(){const[,n]=yield this._semaphore.acquire();return n})}runExclusive(n){return this._semaphore.runExclusive(()=>n())}isLocked(){return this._semaphore.isLocked()}waitForUnlock(){return this._semaphore.waitForUnlock()}release(){this._semaphore.isLocked()&&this._semaphore.release()}cancel(){return this._semaphore.cancel()}}let j=1;async function dn(t,n={useWebWorker:!0}){const{default:i}=await import("./wa-sqlite-async-BQPTkA7Y.js"),h=await i(),a=rn(h),{IDBBatchAtomicVFS:E}=await import("./IDBBatchAtomicVFS-DUL5uCPq.js"),m=new E(t);a.vfs_register(m,!0);const g=await a.open_v2(t),b=new Tn,w=new Map;let f=new Set,l=null;function d(){l=null;const c={tables:[...f],groupedUpdates:{},rawUpdates:[]};f.clear(),Array.from(w.values()).forEach(o=>o(c))}a.register_table_onchange_hook(g,(c,o,u)=>{f.add(o),l==null&&(l=setTimeout(d,0))});const T=async(c,o)=>y(async()=>s(c,o)),y=c=>b.runExclusive(c),s=async(c,o)=>{const u=[];for await(const S of a.statements(g,c)){let I;const N=o?[o]:[[]];for(const q of N){q.forEach((A,C,en)=>{typeof A=="boolean"&&(en[C]=A?1:0)}),a.reset(S),o&&a.bind_collection(S,q);const k=[];for(;await a.step(S)===100;){const A=a.row(S);k.push(A)}I=I??a.column_names(S),I.length&&u.push({columns:I,rows:k})}if(o)break}const p=[];for(const S of u)for(const I of S.rows){const N={};S.columns.forEach((q,k)=>{N[q]=I[k]}),p.push(N)}return{insertId:a.last_insert_id(g),rowsAffected:a.changes(g),rows:{_array:p,length:p.length}}},r=async(c,o)=>y(async()=>{let u=0;const p=a.str_new(g,c),L=a.str_value(p);try{await s("BEGIN TRANSACTION");const I=await a.prepare_v2(g,L);if(I===null)return{rowsAffected:0,rows:{_array:[],length:0}};const N=o||[];for(const q of N){for(let A=0;A<q.length;A++){const C=q[A];typeof C=="boolean"&&(q[A]=C?1:0)}a.reset(I.stmt),o&&a.bind_collection(I.stmt,q),await a.step(I.stmt)===101&&(u+=a.changes(g))}await a.finalize(I.stmt),await s("COMMIT")}catch{return await s("ROLLBACK"),{rowsAffected:0,rows:{_array:[],length:0}}}finally{a.str_finish(p)}return{rowsAffected:u,rows:{_array:[],length:0}}});if(n.useWebWorker){const c=o=>{const u=j++;return w.set(u,o),Q(()=>{w.delete(u)})};return{execute:Q(T),executeBatch:Q(r),registerOnTableChange:Q(c),close:Q(()=>{a.close(g)})}}return{execute:T,executeBatch:r,registerOnTableChange:c=>{const o=j++;return w.set(o,c),()=>{w.delete(o)}},close:()=>a.close(g)}}const Sn=self,U=new Map,In="open-wasqlite-db";let Ln=1;const qn=async t=>navigator.locks.request(In,async()=>{const n=Ln++;if(!U.has(t)){const E=new Set,m=await dn(t);U.set(t,{clientIds:E,db:m})}const i=U.get(t);i.clientIds.add(n);const{db:h}=i,a={...h,close:Q(()=>{const{clientIds:E}=i;if(E.delete(n),E.size==0)return console.debug(`Closing connection to ${t}.`),U.delete(t),h.close?.();console.debug(`Connection to ${t} not closed yet due to active clients.`)})};return Q(a)});Sn.onconnect=function(t){const n=t.ports[0];console.debug("Exposing db on port",n),G(qn,n)};addEventListener("unload",()=>{Array.from(U.values()).forEach(async t=>{(await t.db).close?.()})})})();export{Qn as S,An as a,xn as b,Nn as c,Pn as d,On as e,Rn as f,Dn as g,Hn as h,Bn as i,Wn as j,Un as k,kn as l,Cn as m,vn as n,Kn as o,Fn as p,zn as q,Gn as r,__tla};